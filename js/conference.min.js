function remoteMediaCallback(a){if(a instanceof MediaStream){if(!document.getElementById("vid_"+this.peer)){var b=document.createElement("video");b.id="vid_"+this.peer,b.title=this.peer,b.autoplay=!0,b.onclick=function(){document.getElementById("vid1").title=this.title,reattachMediaStream(document.getElementById("vid1"),this)};var c=document.getElementById("sidevidin").appendChild(b);document.getElementById("sidevidin").firstChild.nextSibling==c&&(document.getElementById("vid1").title=this.peer,attachMediaStream(document.getElementById("vid1"),a),document.getElementById("vid1").style.display="block")}attachMediaStream(document.getElementById("vid_"+this.peer),a)}else if(typeof a=="string"){var d=document.createElement("p");d.innerHTML=this.peer+": "+a,document.getElementById("content").appendChild(d),document.getElementById("content").scrollTop=document.getElementById("content").scrollHeight}else a==null?(document.getElementById("vid_"+this.peer)&&document.getElementById("sidevidin").removeChild(document.getElementById("vid_"+this.peer)),document.getElementById("vid1").title==this.peer&&reattachMediaStream(document.getElementById("vid1"),document.getElementById("sidevidin").firstChild),console.log("delete pc: "+this.peer),delete PCs[this.peer]):console.log("remoteMediaCallback doesn't know how to deal with "+JSON.stringify(a))}function connected(){document.getElementById("friendlist").style.color="inherit",document.getElementById("status").selectedIndex=0,console.log("Socket connected!")}function disconnected(a){document.getElementById("friendlist").style.color="#BBB",document.getElementById("status").selectedIndex=1,console.log("Connection failed! Error: "+JSON.stringify(a))}function bye(a){PCs[a]&&PCs[a].end("Received bye from "+a)}function ice(a){console.log("Received ice from "+a.peer),PCs[a.peer]?PCs[a.peer].addIceCandidate(a.candidate):console.log("Unable to add ice due to PCs["+(a.peer?a.peer:"data.peer")+"] not found")}function online(a){console.log(a+" is online =)");var b=document.createElement("li");b.id="friend_",b.id+=b.innerHTML=b.title=a;var c=document.createElement("button");c.className="fa fa-comment-o",c.type="button",c.innerHTML=" Invite",c.onclick=function(){this.parentNode.className="onCall",invite(this.parentNode.title)},b.appendChild(c),document.getElementById("friends").appendChild(b)}function offline(a){document.getElementById("friend_"+a)&&document.getElementById("friends").removeChild(document.getElementById("friend_"+a))}function disconnect(){document.getElementById("friendlist").style.color="#BBB",document.getElementById("status").selectedIndex=1,document.getElementById("friends").innerHTML="",console.log("Server connection disconnected!")}function offer(a,b){console.log("Received offer from "+a.caller);if(!localstream){console.log("Local stream not ready!"),offerBuffer.push({data:a,fn:b});return}if(participants.indexOf(a.caller)==-1){console.log("Offerer is not in participants!"),b(null);return}a.rtc.type=="offer"&&a.type=="conference"&&(!PCs[a.caller]||!PCs[a.caller].peer?(PCs[a.caller]=new pc(a.caller,a.type,window.opener.signalCh),PCs[a.caller].start(localstream,remoteMediaCallback,a.rtc,b)):PCs[a.caller].peerConnection.signalingState!="stable"||PCs[a.caller].peerConnection.iceConnectionState!="connected"&&PCs[a.caller].peerConnection.iceConnectionState!="completed"?(console.log("Already establishing connection with "+a.caller+", restart connection"),PCs[a.caller].restart(localstream,remoteMediaCallback,a.rtc,b)):(console.log("Already have an established connection with "+a.caller+", reject new connection!"),b(null)))}function invite(a){if(!localstream){alert("Kindly allow the webcam to be accessed first!");return}participants.indexOf(a)==-1&&participants.push(a),window.opener.socket.emit("conference",participants)}function conference(a){if(!Array.isArray(a)||!a.length)return;if(participants.indexOf(a[0])==-1){console.log("Inviter not in participants!");return}for(var b=0;b<a.length;b++)if(participants.indexOf(a[b])==-1)console.log("Added "+a[b]+" into participants"),participants.push(a[b]);else if(!PCs[a[b]]||!PCs[a[b]].peer)PCs[a[b]]=new pc(a[b],"conference",window.opener.signalCh),PCs[a[b]].start(localstream,remoteMediaCallback)}function sendMsg(){var a=document.getElementById("chatbox");console.log("Message:"+a.msg.value);var b=document.createElement("p");b.innerHTML="Me: "+a.msg.value.replace(/\n/g,"<br>"),document.getElementById("content").appendChild(b),document.getElementById("content").scrollTop=document.getElementById("content").scrollHeight;for(key in PCs)PCs[key].dataCh.send(a.msg.value);return a.reset(),!1}function gUM(){getUserMedia({audio:!0,video:!0},function(a){localstream=a,document.getElementById("overlay").style.display="none",attachMediaStream(document.getElementById("vid2"),a),window.opener.buffer&&Array.isArray(window.opener.buffer)?(participants=window.opener.buffer.slice(0),window.opener.buffer=null):participants=new Array;for(var b=0;b<offerBuffer.length;b++)offer(offerBuffer[b].data,offerBuffer[b].fn);offerBuffer.length=0,conference(participants)},function(a){console.log("Get user media error: "+JSON.stringify(a)),confirm("Unable to detect your webcam (check your settings), try again?")?gUM():window.close()})}var PCs=new Array,participants=null,localstream=null,offerBuffer=new Array;window.onload=function(){if(!window||!window.opener)window.location=window.location.protocol+"//"+window.location.hostname;document.getElementById("status").onchange=window.opener.document.getElementById("status").onchange;var a=window.opener.document.getElementById("friends").getElementsByTagName("li");for(var b=0;b<a.length;b++)online(a[b].title);document.getElementById("chatbox").onsubmit=function(){return sendMsg()},document.getElementById("chatbox").msg.onkeypress=function(a){if(a.keyCode==13&&!a.shiftKey)return sendMsg(this.form),!1},gUM()},window.onunload=function(){for(key in PCs)PCs[key].end()}