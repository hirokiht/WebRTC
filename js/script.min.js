function signalCh(a){var b=this;a=="bye"?socket.emit(a,{peer:this.peer,type:this.type}):a==null||typeof a.sdp=="string"?a==null||this.peerConnection.remoteDescription?this.callback(a):(console.log("Sending offer to "+this.peer),socket.emit("offer",{callee:this.peer,type:this.type,rtc:a},function(a){a==null?b.type=="conference"&&conWin&&!conWin.closed?(b.end(b.peer+" failed to provide valid answer!"),conWin.alert(b.peer+" is unavailable right now!")):(b.end(b.peer+" failed to provide valid answer!"),alert(b.peer+" is unavailable right now!")):b.setAnswer(a)})):typeof a.candidate=="string"?socket.emit("ice",{to:this.peer,icecandidate:a}):console.log("Signal Channel dont know how to deal with this: "+JSON.stringify(a))}function remoteVideoMediaCallback(a){a?(attachMediaStream(document.getElementById("vid1"),a),document.getElementById("vid1").style.display="block",document.getElementById("endcall").onclick=function(){videoPC.end("User requested to end")},document.getElementById("endcall").style.display="block"):(document.getElementById("vid1").pause(),document.getElementById("vid1").style.display="none",document.getElementById("endcall").style.display="none",videoPC=null)}function localVideoMediaCallback(a){a?(attachMediaStream(document.getElementById("vid2"),a),document.getElementById("vid2").style.display="block"):(document.getElementById("vid2").pause(),document.getElementById("vid2").style.display="none")}function remoteDataMediaCallback(a){if(!a)return;if(document.getElementById("tabs-"+this.peer)){var b=document.createElement("p");b.innerHTML=this.peer+": "+a,document.getElementById("tabs-"+this.peer).firstChild.appendChild(b),document.getElementById("tabs-"+this.peer).firstChild.scrollTop=document.getElementById("tabs-"+this.peer).firstChild.scrollHeight}else console.log("tab for "+this.peer+" not found!")}function localDataMediaCallback(a){if(a=="enable")document.getElementById("tabs-"+this.peer)?document.getElementById("tabs-"+this.peer).style.display("block"):addTab(this.peer);else if(a=="disable"||a==null)removeTab(this.peer),console.log("delete pc:"+this.peer),delete dataPCs[this.peer]}function videoCall(a){videoPC=new pc(a,"video",signalCh),videoPC.start(localVideoMediaCallback,remoteVideoMediaCallback)}function text(a){!dataPCs[a]||!dataPCs[a].peer?(dataPCs[a]=new pc(a,"data",signalCh),dataPCs[a].start(localDataMediaCallback,remoteDataMediaCallback)):document.getElementById("tabs-"+a)?showTab(a):addTab(a)}function sendMsg(a){var b=document.createElement("p");return b.innerHTML="Me: "+a.msg.value.replace(/\n/g,"<br>"),a.firstChild.appendChild(b),a.firstChild.scrollTop=a.firstChild.scrollHeight,dataPCs[a.id.substr(5)]&&dataPCs[a.id.substr(5)].dataCh?dataPCs[a.id.substr(5)].dataCh.send(a.msg.value):console.log("Data channel is not opened!"),a.reset(),!1}function addTab(a){var b=$("#chattabs"),c='<li><a href="#{href}" class="fa fa-user"> #{label}</a> <span class="fa fa-times" role="presentation"></span></li>',d="tabs-"+a,e=$(c.replace(/#\{href\}/g,"#"+d).replace(/#\{label\}/g,a)),f='<div class="content"></div><div class="controls"><textarea name="msg"></textarea><button type="submit" class="fa fa-envelope-o"> Send</button></div>';b.find(".ui-tabs-nav").append(e),b.prepend('<form id="'+d+'" onsubmit="return sendMsg(this);">'+f+"</form>"),b.tabs("refresh"),$(".tabs-bottom .ui-tabs-nav, .tabs-bottom .ui-tabs-nav > *").removeClass("ui-corner-all ui-corner-top"),$(".tabs-bottom .ui-tabs-nav, .tabs-bottom .ui-tabs-nav > *").addClass("ui-corner-bottom"),document.getElementById(d).msg.onkeypress=function(a){if(a.keyCode==13&&!a.shiftKey)return sendMsg(this.form),!1},b.tabs("option","active")||b.tabs("option","active",-1)}function showTab(a){$("#chattabs-"+a).show(),$("#chattabs>ul.ui-tabs-nav>li[aria-controls=tabs-"+a+"]").show(),$("#vidbox").css("height","70%")}function removeTab(a){var b;(b=document.getElementById("tabs-"+a))&&document.getElementById("chattabs").removeChild(b),$("#chattabs>ul.ui-tabs-nav>li[aria-controls=tabs-"+a+"]").remove(),$("#chattabs >ul >li").length||$("#vidbox").css("height","99%"),$("#chattabs").tabs("refresh")}function dialogIsOpen(){return $("#confirm").dialog("isOpen")}function showDialog(a,b){dialogIsOpen()&&$("#confirm").dialog("close"),updateDialog(a,b),$("#confirm").dialog("open")}function updateDialog(a,b){var c=$("#confirm").dialog("option","buttons");typeof a=="function"&&(c[0].click=function(){a(),$(this).dialog("close")}),typeof b=="function"&&(c[1].click=function(){b(),$(this).dialog("close")}),$("#confirm").dialog("option","buttons",c)}var socket=io.connect(window.location.href),videoPC=null,dataPCs=new Array,conWin=null,buffer=null;socket.on("connect",function(){document.getElementById("friendlist").style.color="inherit",document.getElementById("status").selectedIndex=0,console.log("Socket connected!"),conWin&&!conWin.closed&&conWin.connected()},function(a){document.getElementById("friendlist").style.color="#BBB",document.getElementById("status").selectedIndex=1,console.log("Connection failed! Error: "+JSON.stringify(a)),conWin&&!conWin.closed&&conWin.disconnected(a)}),socket.on("bye",function(a){console.log("Received bye from "+a.peer),videoPC&&videoPC.peer==a.peer&&a.type=="video"&&videoPC.end("Received bye"),dataPCs[a.peer]&&a.type=="data"&&dataPCs[a.peer].end("Received bye from "+a.peer),conWin&&!conWin.closed&&a.type=="conference"&&conWin.bye(a.peer)}),socket.on("ice",function(a){console.log("Received ice from "+a.peer),videoPC&&videoPC.peer==a.peer&&videoPC.addIceCandidate(a.candidate),dataPCs[a.peer]&&dataPCs[a.peer].addIceCandidate(a.candidate),conWin&&!conWin.closed&&conWin.ice(a)}),socket.on("online",function(a){console.log(a+" is online =)");var b=document.createElement("li");b.innerHTML=b.title=a,b.appendChild(document.createElement("br")),b.id="friend_"+a;var c=document.createElement("button");c.type="button",c.innerHTML="Video Call",c.onclick=function(){this.parentNode.className="onCall",videoCall(this.parentNode.title)},b.appendChild(c);var d=document.createElement("button");d.innerHTML="Text Chat",d.onclick=function(){text(this.parentNode.title)},b.appendChild(d),document.getElementById("friends").appendChild(b),conWin&&!conWin.closed&&conWin.online(a)}),socket.on("offline",function(a){document.getElementById("friend_"+a)&&document.getElementById("friends").removeChild(document.getElementById("friend_"+a)),conWin&&!conWin.closed&&conWin.offline(a)}),socket.on("disconnect",function(){document.getElementById("friendlist").style.color="#BBB",document.getElementById("status").selectedIndex=1,document.getElementById("friends").innerHTML="",console.log("Server connection disconnected!"),conWin&&!conWin.closed&&conWin.close()}),socket.on("offer",function(a,b){console.log("Received offer from "+a.caller);if(a.rtc.type=="offer")if(a.type=="video"){if(a.rtc.sdp.indexOf("m=vid")<0){console.log("Received invalid sdp for video call"),b(null);return}videoPC&&videoPC.peer?b(null):confirm("Accept video call from "+a.caller+"?")?(videoPC=new pc(a.caller,"video",signalCh),videoPC.start(localVideoMediaCallback,remoteVideoMediaCallback,a.rtc,b)):b(null)}else a.type=="data"?(dataPCs[a.caller]||(dataPCs[a.caller]=new pc(a.caller,"data",signalCh)),dataPCs[a.caller].start(localDataMediaCallback,remoteDataMediaCallback,a.rtc,b)):a.type=="conference"?!conWin||conWin.closed?(b(null),console.log("Not READY for conference!!!!")):conWin.offer(a,b):console.log("Unsupported offer type: "+a.type)}),socket.on("conference",function(a){if(!Array.isArray(a)){console.log("Invalid conference data");return}if(!conWin||conWin.closed)if(dialogIsOpen&&buffer!=null&&Array.isArray(buffer))if(buffer.indexOf(a[0])!=-1){for(var b=0;b<a.length;b++)buffer.indexOf(a[b])==-1&&buffer.push(a[b]);document.getElementById("confirm").innerHTML=a.toString(),showDialog(function(){conWin=window.open("/conference","conference","menubar=no,status=no")})}else console.log("Pending conference request unresolved yet, reject current request");else buffer=a,document.getElementById("confirm").innerHTML=a.toString(),showDialog(function(){conWin=window.open("/conference","conference","menubar=no,status=no")});else conWin.conference(a)}),$(function(){var a=$("#chattabs").tabs({show:"slideDown",hide:"slideUp",collapsible:!0,heightStyle:"fill"});$(".tabs-bottom .ui-tabs-nav, .tabs-bottom .ui-tabs-nav > *").removeClass("ui-corner-all ui-corner-top"),$(".tabs-bottom .ui-tabs-nav, .tabs-bottom .ui-tabs-nav > *").addClass("ui-corner-bottom"),a.on("tabsactivate",function(a,b){$("#chattabs").css("width","100%"),!b.newTab[0]&&!b.newPanel[0]?$("#vidbox").css("height","95%"):$("#vidbox").css("height","70%")}),a.on("click","span.fa-times",function(){var a=$(this).closest("li").attr("aria-controls");$("#"+a).hide(),$(this).closest("li").hide(),$("#chattabs >ul").find("li:hidden").length==$("#chattabs >ul >li").length&&$("#vidbox").css("height","99%")}),$("#confirm").dialog({resizable:!1,draggable:!1,closeOnEscape:!1,autoOpen:!1,modal:!0,buttons:[{text:"Accept",icons:{primary:"ui-icon-check"},click:function(){$(this).dialog("close")}},{text:"Decline",icons:{primary:"ui-icon-closethick"},click:function(){$(this).dialog("close")}}],show:!0})}),window.onbeforeunload=function(){},window.onload=function(){document.getElementById("status").onchange=function(){document.getElementById("status").selectedIndex?socket.disconnect():socket.socket.connect()},document.getElementById("conference").onclick=function(){conWin&&!conWin.closed?conWin.focus():conWin=window.open("/conference","conference","menubar=no,status=no")}},window.onbeforeunload=function(){return conWin&&!conWin.closed?"Are you sure? This will close all video and conference calls!":null},window.onunload=function(){videoPC&&videoPC.end();for(key in dataPCs)dataPCs[key].end();conWin&&!conWin.closed&&conWin.close()}