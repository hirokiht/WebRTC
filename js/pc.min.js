function pc(a,b,c){this.type=b||"video";var d=this,e=[{DtlsSrtpKeyAgreement:!0}],f=[createIceServer("stun:stun.l.google.com:19302")];this.peerConnection=new RTCPeerConnection({iceServers:f},{optional:e}),this.peer=a,this.dataCh=null,this.signal=c||function(){},this.ice=Array(),this.callback=null,this.keepAliveInterval=null,this.deadCounter=0,this.localMediaCb=null,this.remoteMediaCb=null,this.debug=!1,this.peerConnection.onicecandidate=function(a){a.candidate?(g("Sending ice candidate to "+d.peer+":"+JSON.stringify(a.candidate)),d.signal(a.candidate)):g("Finish sending ice candidates!")},this.peerConnection.onaddstream=function(a){if(!a)return;g("Receiving stream: "+JSON.stringify(a.stream)),d.remoteMediaCb(a.stream)},this.peerConnection.onnegotiationneeded=function(a){g("Negotiation needed: "+JSON.stringify(a))},this.peerConnection.onremovestream=function(a){g("Stream removed: "+JSON.stringify(a))},this.peerConnection.oniceconnectionstatechange=function(a){this.iceConnectionState=="closed"||this.iceConnectionState=="failed"?d.end("ice "+this.iceConnectionState+"!"):this.iceConnectionState=="disconnected"?setTimeout(function(){d.peerConnection&&d.peerConnection.iceConnectionState=="disconnected"&&d.end("Ice Connection State is disconnected for 3 seconds")},3e3):g("iceConnectionState changed: "+this.iceConnectionState)},this.peerConnection.onsignalingstatechange=function(a){g("signalingState changed: "+d.peerConnection.signalingState),d.peerConnection.signalingState=="stable"&&this.iceConnectionState=="connected"&&console.log("Established "+d.type+" connection to "+d.peer)},this.peerConnection.ondatachannel=function(a){g("On data channel..."),d.initDataCh(a.channel)},this.addIceCandidate=function(a){if(this.peerConnection.iceGatheringState=="new")this.ice.push(a),g("Received ice for "+this.peer+", add to queue");else try{this.peerConnection.addIceCandidate(new RTCIceCandidate(a),function(){console.log("Adding ICE candidate: "+JSON.stringify(a))},function(a){console.log("Failed to add ICE candidate: "+JSON.stringify(a))})}catch(b){this.peerConnection.addIceCandidate(new RTCIceCandidate(a)),console.log("Adding ICE candidate(fallback): "+JSON.stringify(a))}};var g=function(a){d.debug&&console.log(a)},h=function(a){d.peerConnection.setLocalDescription(a,function(){g("Sending "+(d.peerConnection.remoteDescription?"answer":"offer")+" to "+d.peer+":\n"+a.sdp),d.signal(a)},function(a){console.log("Error setLocalDescription: "+JSON.stringify(a)),this.close()})},i=function(){d.deadCounter>=1&&d.deadCounter++;try{d.dataCh.send("hello")}catch(a){console.log("Unable to send hello, reason:"+JSON.stringify(a))}d.deadCounter>6&&d.end("PC seems to be dead, killing it.")};this.initDataCh=function(a){this.dataCh=a||this.peerConnection.createDataChannel("dataCh");try{this.dataCh.binaryType="blob"}catch(b){this.dataCh.binaryType="arraybuffer"}this.dataCh.onmessage=function(a){g(d.peer+": "+a.data),a.data instanceof Blob&&alert("blob"),d.type=="data"||d.type=="conference"?d.remoteMediaCb(a.data):a.data=="hello"?this.send("clr"):a.data=="clr"&&(d.deadCounter=1)},this.dataCh.onopen=function(){g("DataCh onopen event, readyState: "+this.readyState),d.type=="data"?d.localMediaCb("enable"):d.type=="video"&&(d.keepAliveInterval=setInterval(i,2e3))},this.dataCh.onclose=function(){d.type=="data"&&typeof d.localMediaCb=="function"&&d.localMediaCb("disable"),d.end("Data Channel on close event")},!a&&this.type=="data"&&this.peerConnection.createOffer(h,function(a){console.log("Failed to create offer: "+JSON.stringify(a))})};var j=function(){while(d.ice.length){var a=d.ice.pop();try{d.peerConnection.addIceCandidate(new RTCIceCandidate(a),function(){console.log("Adding ICE candidate: "+JSON.stringify(a))},function(a){console.log("Failed to add ICE candidate: "+JSON.stringify(a))})}catch(b){d.peerConnection.addIceCandidate(new RTCIceCandidate(a)),console.log("Adding ICE candidate(fallback): "+JSON.stringify(a))}}d.peerConnection.localDescription?g("No need create answer..."):d.peerConnection.createAnswer(h,function(a){d.signal(null),d.end("Failed to create answer to "+d.peer+"\nError: "+JSON.stringify(a))}),g("Successfully set remote description!")};this.setAnswer=function(a){g("Received answer from "+this.peer+": "+a.sdp),this.peerConnection.setRemoteDescription(new RTCSessionDescription(a),j,function(a){d.end("Failed to set remote description, error: "+JSON.stringify(a))})},this.start=function(a,b,c,e){!window.MediaStream&&window.webkitMediaStream&&(MediaStream=webkitMediaStream),this.type=="video"||this.type=="conference"?typeof a=="function"?getUserMedia({audio:!0,video:!0},function(f){a(f),d.start(f,b,c,e)},function(a){console.log("ERROR on getUserMedia(): "+JSON.stringify(a))}):a instanceof MediaStream?(d.peerConnection.addStream(a),e==null?(d.initDataCh(),d.peerConnection.createOffer(h,function(a){console.log("Failed to create offer: "+JSON.stringify(a))})):c&&c.sdp.indexOf("m=vid")>=0?(d.peerConnection.setRemoteDescription(new RTCSessionDescription(c),j,function(a){console.log("Failed to set remote description, error: "+JSON.stringify(a)),d.signal(null)}),this.callback=e):console.log("Invalid session description received, no video media for conference peer connection!\n"+JSON.stringify(c)),this.remoteMediaCb=b):console.log("Invalid localMedia type, unable to initialize peer connection"):this.type=="data"?(e==null?this.initDataCh():c?(this.peerConnection.setRemoteDescription(new RTCSessionDescription(c),j,function(a){console.log("Failed to set remote description, error: "+JSON.stringify(a)),d.signal(null)}),this.callback=e):console.log("Invalid start parameters!"),this.localMediaCb=typeof a=="function"?a:function(a){},this.remoteMediaCb=b):console.log("Unrecognized pc type: "+this.type)},this.restart=function(a,b,c,d){this.peerConnection&&this.peerConnection.signalingState!="closed"&&this.peerConnection.close(),this.localMediaCb=null,this.remoteMediaCb=null,this.peerConnection=new RTCPeerConnection({iceServers:f},{optional:e}),this.start(a,b,c,d)},this.end=function(a){a?console.log("Peer Connection closed, reason:\n"+a):console.log("Peer connection closed due to unspecified reason."),this.peerConnection&&this.peerConnection.signalingState!="closed"&&this.peerConnection.close(),this.peerConnection=null,this.signal&&this.signal("bye"),this.signal=null,this.localMediaCb&&this.localMediaCb(null),this.remoteMediaCb&&this.remoteMediaCb(null),this.peer=null,this.keepAliveInterval&&clearInterval(this.keepAliveInterval),this.keepAliveInterval=null,this.deadCounter=0,this.localMediaCb=null,this.remoteMediaCb=null,delete this}}